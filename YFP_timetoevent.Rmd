---
title: "Applying survival analysis techniques to understand time to appearance of YFP"
output: html_notebook
---

### Introduction

In the study this notebook is based on, the ability to repair a single induced double strand break using single-strand annealing (SSA) was compared for cohorts of old and young cells as well as different strains.  Cells were observed for a fixed time period, during which a double strand break was induced and the cells followed for appearance of YFP (a reporter designed to indicate succesful SSA repair). The questions of interest here are:

1) How the speed of double strand break induction, SSA repair and subsequent YFP expression differs between old and young cells of the same strain. 
2) How the speed of double strand break induction, SSA repair, and subsequent YFP expression differs between cells of different strains.

These questions were previously addressed by first selecting cells were observed alive at a fixed time point, and comparing the fraction of cells that had became YFP positive at the time point. However, techniques from survival analysis provide another powerful way to answer these questions. One advantage of these techniques is the ability to estimate the time-to-event distribution for YFP appearance, not just for those cells that survived up to a fixed time point. Secondly, survival analysis techniques have built in ways to account for censoring. In the experiments, cells were censored due to death (bursting), the inability to follow them at later time points due to crowding from neighbors, and a limited maximal follow-up time.  Thirdly, regression approaches to survival analysis allow for quantification of the effects of strain, age, and other variables on the time to YFP expression.


### Two views of the YFP time-to-appearance data

The cells in each experiment can be viewed as follows:
  a) a mixture of cells which can be repaired and cannot be repaired, where the cells that can be repaired have a survival distribution that we want to estimate
  b) a single population of cells with the same survival distribution. The cells for which repair is not observed would be repaired if they are immortal and could be followed for an infinite amount of time. This is impossible though, since cells will die before these repair events can happen
  
In the first scenario, different strains have different fractions of cells that can be repaired by SSA. The way that heteroduplex rejection is described in the literature(SSAhet) is more consistent with this first scenario; if cells reject the SSA repair template they will never pursue SSA and never produce YFP.

In the second scenario, different strains have the same fraction of cells that will eventually be repaired - but some strains repair faster. With the example of heteroduplex rejection (SSAhet), the reason there are fewer cells of the SSAhet strain is because SSA repair is very slow in these cells. We just don't see repair happen because we cannot wait forever - cells will die before then.

These two views affect the consideration of which cells will be used to estimate the survival function. If only a fraction of cells can be repaired, it makes sense to consider the time to repair for only those cells that can be repaired.  In this case only consider time-to-YFP appearance for cells in which YFP is observed to appear. If instead we think that all cells can be repaired, but we can't observe the later repair times,  it would make sense to consider the time to repair for all cells, including those that are still YFP negative at the end of follow-up.

### The data
Cells were aged and recorded in a movie (part 1) prior to starting a fluorescent movie (part 2) to measure the timing of repair. In both movies, non-fluorescent images were taken at 10 minute intervals to record cell division times.   For the 'young' cell experiments, cells were aged for 27*10/60 = 4.5 h in part 1. For the 'old' cell experiments, cells were aged for 153*10/60 = 25.5 h in part 1. To induce the site specific double strand breaks, a drug containing media was added cells for 4 hours starting at 2.5 hours into the fluorescent movie. The drug induces expression of a protein that recognizes a single DNA cut site in the repair casette.

Prior to assessing changes in YFP fluorescence, the non-fluorescent channels of part1 and part2 were joined in order. For each cell born within the first 500 minutes of the combined movie, each budding event was recorded over time. For the young movies, budding events were recorded up to the 1430 min = 23.8 h of the combined movie.  For the old movies, budding events were recorded up to the 2730 min =  45.5 hour of the combined movie. If a cell exhibited a burst phenotype and stopped dividing prior to these time points, the time of occurence was recorded. If a cell was unfollowable due to buildup of neighboring cells, the time of occurrence was also recorded. These event times were all recorded with the 10 minute interval index.

In the fluorescent movie, snapshots of cells were taken at 30 minute intervals.  The YFP of cells were tracked for the first 24 time points. The cells that were not YFP positive by the 24th time point were followed up to the 40th time point.  The last measurement of a cell in a fluorescent movie at which YFP was negative was record in the 'lasttimebelowcutoff' column. Whether YFP went from negative to positive is saved in the 'yfpclass' column.


### Sections
1. Visualizing the fractions and distribution of censoring events in different experiments.  The distribution and fractions of cell death times are also plotted.
2. Comparison of Kaplan-Meier survival curves for different strains. These measure the time-to-event distribution for cell death by bursting.
3. Visualizing cumulative incidence of YFP appearance for cells of different strains.
4. Cause specific hazard modeling of time-to-YFP-appearance using proportional hazards regression. This is applied to either the entire set of cells in each experiment, or only the cells in which repair was observed.

```{r}
setwd('/Users/thomasyoung/Dropbox/DataScienceProjects/SSA_OtherAnalyses')
source('./functions/timeseries_func.Rd')
source('./functions/func.Rd')
source('./functions/Preprocessing_func.Rd')

library(dplyr)
library(reshape2)
library(ggplot2)
library(gridExtra)

```

```{r}
fontsizes =  theme(plot.title=element_text(size=9),strip.text=element_text(size=4))
xtscale_p1start = scale_x_continuous(name='Time (h)',breaks = seq(1,270,24),labels = seq(0,269/6,4))
ytscale_p1start = scale_y_continuous(name='Time (h)',breaks = seq(1,270,24),labels = seq(0,269/6,4))

xtscale_pgtime = scale_x_continuous(name='Time (h)',breaks = seq(0,120,12),labels = seq(0,120/6,2))
xtscale_fltime = scale_x_continuous(name='Time (h)',breaks = seq(0,40,4),labels = seq(0,40/2,2))

```



Reading in data, and checking that the entries in the two files agree with one another
```{r}
info = read.csv('./CombinedData/info_sameasmanualbgflcorrected.csv')
yfp = read.csv('./YFPclassification_includinglatermeasurementsforsomecells/yfpclasses_final2.csv')
#Checking that the xy locations in the two files line up as due the trap numbers - the rows correspond to the same cells
par(mfrow=c(1,2))
plot(info$xy,yfp$xy)
abline(a=0,b=1)
plot(info$trap,yfp$trap)
abline(a=0,b=1)
```

Removing cells from the old experiments that are <= 14 generations old, and the cells from young experiments that are >= 6 generations old.

```{r}
#separating budding times from the rest of the info table
bt = getbudtimes(info)
info = info[,1:(which(colnames(info)=='birth')-1)]
ids = info$id
bt = cbind(ids,info)

#Only looking at the old cells that are age 13 or older at the time of doxycycline addition
condition = (info$ageatdox<=5 & info$doxtime==43) | (info$ageatdox>=15 & info$doxtime==169)
info = filter(info,condition)
yfp =filter(yfp,condition)
bt = filter(bt,condition)

#Only consider cells that start off as YFP negative in the fluorescence movie
condition = yfp$yfpclass != 'alwayson'
info = filter(info,condition)
yfp = filter(yfp,condition)
bt = filter(bt,condition)

#Removing stains for which YFP was not measured at intermediate time points
condition = info$expstrain != 'SSA Rad52ko' & info$expstrain != 'SSA Rad51ko'
info = filter(info,condition)
yfp = filter(yfp,condition)
bt = filter(bt,condition)

```

Checking the counts of cells for each age, strain combination
```{r}
info %>% group_by(expage,expstrain) %>% summarize(count = n())
```

Adding the yfp event data to the info dataframe. 'lastofftime' is the last observed time when YFP in a cell is below the threshold for calling the cell YFP+. The time is measured in increments of 30 minutes from the start of the fluorescence movie. 'yfpclass' specifies whether the cell was recorded as having YFP gone from negative to positive ('turnedon') or always being YFP negative ('alwaysoff')
```{r}
info$yfpclass = yfp$yfpclass
info$lastofftime = yfp$lastofftime
```


### 1. Visualizing the fractions and distribution of censoring and death events in different experiments. 

The lastobservation field can either be 'burst' or 'interference'. If it is 'burst' the cell was observed as having a dead morphology at some time point. If 'interference', it was not possible to continue following the cell due crowding of the field of view, or the end of the pre-chosen observation period was reached.  Every cell was followed until one of these events occured.  The time of at which these events occured is in the lastobservationtime column.

For each strain + age combination, I compute the fraction of followed cells that 1) burst, or 2) where interfered with prior to the end observation period (270 for old cells, and 130 for young cells)
```{r}

lastobsdetailed = info$lastobservation
lastobsdetailed[lastobsdetailed == 'interference' & ((info$lastobservationtime >= 140 & info$expage =='young') | 
  (info$lastobservationtime >= 270 & info$expage=='old'))] = 'alive at eof'
info$lastobsdetailed = lastobsdetailed


summ <- info %>% group_by(agestrain,expage,expstrain,lastobsdetailed) %>% summarise(count = n())
summ1 <- summ %>% group_by(agestrain,expage,expstrain) %>% mutate(fraction = count/sum(count))


#fraction of cells that burst, were lost to observation, or were alive at the end of followup
p1 <- ggplot(summ1,aes(x = lastobsdetailed,y=fraction)) + geom_bar(stat="identity",aes(fill=lastobsdetailed),position = "dodge") + facet_grid(expstrain~expage) + coord_flip() + ylim(0,1) + ggtitle('fraction of cells by type of censoring') + fontsizes + theme(axis.title.y = element_blank(), axis.text.y=element_blank(),axis.ticks.y=element_blank())
p1

#Side by side boxplots of last observation time for each strain. Color coded by whether the last event was interference (cell not observable) or bursting
p1 <- ggplot(info,aes(x=expstrain,y=lastobservationtime)) + geom_boxplot(aes(colour=lastobservation)) + facet_grid(.~expage) + coord_flip() + ggtitle('last observation times by type of censoring') + fontsizes + ytscale_p1start
p1

#Checking the distribution of lastobservation time for the old experiments
p1 = info %>% filter(expage=='old') %>% ggplot(aes(x=lastobservationtime)) + geom_histogram() + xlim(210,275)+ facet_grid(.~expstrain) + theme(aspect.ratio=1) + xlab('time (raw increments, 10 minute intervals))') + ggtitle('old')

#checking the distribution of last observation time for the young experiments
p2 = info %>% filter(expage=='young') %>% ggplot(aes(x=lastobservationtime)) + geom_histogram() + xlim(100,160)+ facet_grid(.~expstrain) + theme(aspect.ratio = 1)+ xlab('time (raw increments, 10 minute intervals))')+ ggtitle('young')

grid.arrange(grobs = list(p1,p2),layout_matrix=matrix(c(1,2)))
```
Looking at the fractions of cells that burst, were lost to observation, or were alive at end of followup ('eof'), there are clear differences between the 'young' and 'old' experiments. The fraction of cells that burst during the old followup time ranged from ~15% to ~40% for old cells but was < 10% for young cells.The fraction of cells for which intereference (loss to followup) occured ranged from ~8% to 50% for old cells, but was < 25% for young cells.   
There were also different fractions of cells that burst or were lost to observation for different strain of the same age. For example old SSA 3xCln2 experiments had less than 10% of interference, while old SSA Dnl4ko had ~50% interference.

Interference (loss to observation either prior to or at the end of the followup period), and bursting also had different distributions with respect to times. In the boxplots, the middle 50% of bursting times tended to occur between the 32nd and 38th hour. The interference times were concentrated at later time points because a large proportion of cells made it to the end of the followup time.  The distributions also show variability across different strains of each age group.

Histograms of interference times confirm that in across old experiments and across young experiments, cells were followed to the same maximal time point (> 270 in raw increments for the old cells, and > 140 in raw increments for the young cells).  These correspond to the peaks in the histograms since relatively high fractions of cells were alive at the end of observation. In the remainder of the notebook, when comparing time-to-event data only times less than these maximal times will be used.


### 2. Comparison of Kaplan-Meier survival curves for death (bursting) in different age groups and strains.

Bursting of cells is an important outcome to consider when comparing differences in SSA repair between the strains. Bursting prior to repair prevents observation of repair. It might also be related to repair itself; cells that fail to repair might burst, while cells that are slow to repair might burst before they can be repaired. Since differences in the fraction of bursting across strains and age-groups were clear in the previous section, it makes sense to consider the time-to-event distribution for bursting. 

Kaplan-Meier survival curves are the most popular way of looking at survival distributions. Given t = time to event and T = the x value on the curve, the y-value on a Kaplan-Meier curve is the estimated P(t > T). Kaplan-Meier survival curves also account for censoring, but assume that the censoring is non-informative. Non-informative means that censored outcomes have the same time to event distribution as un-censored outcomes. Below, I compute Kaplan-Meier curves for the time to bursting for each strain + age group in my data.

The time in these curves is measured relative to the time of treatment with the double-strand break inducing drug. The reason for defining this as the time is that the focus of the study is the effect of cell age on the response to the double-strand break. All cells are restricted to be alive at the time of drug addition.

```{r}
library(survival)
library(ggfortify)
library(survminer)
library(gridExtra)
```


Define a coding for the bursting survival curves, and the YFP appearance survival curves
Measure time from the addition of the drug for double strand break induction in 10 minute units (for time to bursting), and 30 minute units (for time to YFP appearance)
```{r}

info$lastobspt2index = lastflindexbefore(info$lastobservationtime,3,info$lastibeforepart2 + 1)

#Define statusburst to be 1 if the lastobservationtime was 'burst' and 0 if the cell was censored
#Define statusyfp to be 1 if yfpclass was 'turnedon', and 0 otherwise
info <- info %>% mutate(statusburst = if_else(lastobservation=='burst',1,0),
  statusyfp = if_else(yfpclass =='turnedon',1,0))

#Define the time for the bursting event to be measured from the time of drug addition, increments of 10 min
info <- info %>% mutate(timeburst = lastobservationtime - doxtime)

#Define the time for YFP appearance to be measured from the time of drug addition (actually the last part 2 index before drug addition), increments of 30 minutes.  The xscale has to be changed later to hours.
#If no YFP appears, timeyfp will be instead be the lastobservationtime, measured in 30 minute increments from the last part2 indexbefore drug addition
info <- info %>% mutate(timeyfp = if_else(yfpclass == 'turnedon',lastofftime-5,lastobspt2index-5))

```


Below, the old and young Kaplan Meier curves are plotted for each strain.  
```{r, fig.width = 6, fig.height = 3,out.width = 30, out.height = 20}
infoold <- info %>% filter(expage =='old')
infoyoung <- info %>% filter(expage =='young')

#SSAdegcontrol was not measured for the 'young' condition
strainnames = c('SSA','SSAcontrol','SSA Dnl4ko', 'SSAdeg','SSAhet','SSA3xCln2')

burstkmbyagegrp <- function(strainname){
  km_fit <- survfit(Surv(timeburst,statusburst)~ expage,data = info[info$expstrain == strainname,])
  p1 = autoplot(km_fit) + xtscale_pgtime + ylim(0,1) + ggtitle(strainname)
}

burstkmbyagelist = lapply(strainnames,burstkmbyagegrp)
grid.arrange(grobs = burstkmbyagelist,layout_matrix = rbind(c(1,2,3),c(4,5,6)), top = "Kaplan-Meier Curves for Bursting In Old vs Young Cells of each Strain")


burstlgrankpv_byagegrp <- function(strainname){
  sd <- survdiff(Surv(timeburst,statusburst)~ expage,data = info[info$expstrain == strainname,])
  return(1-pchisq(sd$chisq,length(sd$n)-1))
}

pvlist = lapply(strainnames,burstlgrankpv_byagegrp)
names(pvlist) = strainnames
print('logrank p-values comparing old and young time-to-burst survival distributions within each strain')
pvlist
```
For all strains the old cells survival curves decline faster than the young cell survival curves. This is not surprising since older cells are closer to death than younger cells, and are therefore more prone to bursting over the follow-up time. Applying the log rank test co compare the young and old survival distributions for each strain, the p-values for all strains except SSA 3xCln2 are less than 0.005. The p-value for comparing the young and old SSA3xCln2 distribution was 0.06, but the survival distribution for the young cells is unknown beyond the 14 hour time point.

The different levels of bursting in young and old cohorts should be considered when comparing repair between the cohorts.

In comparing different strains of the same age, it also makes sense to compare the survival distributions with bursting as the outcome variable
```{r,fig.width = 6, fig.height = 3,out.width = 30, out.height = 20}
strainnames = c('SSAcontrol','SSA Dnl4ko', 'SSAdeg','SSAhet','SSA3xCln2')

burstkmbystrain <- function(strainname,controlstrainname,agegroup){
  km_fit <- survfit(Surv(timeburst,statusburst)~ expstrain,data = info[(info$expstrain == strainname | info$expstrain ==controlstrainname) & info$expage == agegroup,])
  p1 = autoplot(km_fit) + xtscale_pgtime + ylim(0,1) + ggtitle(strainname)
}

burstkmbyagelist = lapply(strainnames,burstkmbystrain,'SSA','old')
grid.arrange(grobs = burstkmbyagelist,layout_matrix = rbind(c(1,2,3),c(4,5,6)),top = 'Kaplan Meier Curves for Bursting (death) by Strain, Old Experiments Only')

burstlgrankpv_bystrain <- function(strainname,controlstrainname,agegroup){
  sd <- survdiff(Surv(timeburst,statusburst)~ expstrain,data = info[(info$expstrain == strainname | info$expstrain ==controlstrainname) & info$expage == agegroup,])
  return(1-pchisq(sd$chisq,length(sd$n)-1))
}

pvlist =
  lapply(strainnames,burstlgrankpv_bystrain,'SSA','old')
names(pvlist) = strainnames
print('logrank p-values comparing old time-to-burst survival distributions for each strain against SSA')
pvlist
```
Comparing Kaplan Meier curves for time-to-bursting among old cells, the two strains that appear to have a differenet distribution from the SSA strain are the SSA Dnl4ko strain (log rank p-value = 0.004), and SSA3xCln2 strain (log rank p-value = 0.001). While old SSA strain cells have a 95% CI for P(time to bursting >= 17 hours) ranging from ~0.4 to 0.7, the SSA Dnl4ko strain' as an's CI ranges from ~0.65 to ~0.9. All other strains Kaplan Meier survival curves show a high degree of overlap with the SSA strain. Why the SSA Dnl4ko and SSA3xCln2 strains show a different time-to-bursting distribution is an interesting mystery to investigate.



### 3. Comparing the cumulative incidence function for YFP production.  

The next step is to look at how time-to-YFP appearance is affected by age as well as the various genetic modifications in the study. When comparing different cohorts, one complication is different degrees of cell death and censoring. Data from the SSAcontrol strain shows that for old cells, bursting even occurs in the absence of double-strand break induction.

The approach used to account for bursting depends on what bursting means in the context of the YFP detection assay. If inability to repair the induced double strand break causes bursting, then increased rates of bursting at the expense of YFP appearance would suggest decreased repair efficiency. If instead, burst cells are unable to induce double-strand breaks, they provide no information about SSA repair efficiency. Since bursting occurs at higher rates in old cells regardless of whether double-strand breaks are induced, it cannot be seen simply as an outcome of the SSA repair assay in the old cells. 

Below, I include any influence of bursting on YFP appearance by estimating the cumulative incidence of YFP appearance. The cumulative incidence function at time t estimates the marginal probability that event occurs at time less than t.  It is dependent not only on the rate that the event occurs, but on the rate of competing events that prevent the event of interest form occuring. In the case of these experiments, bursting could be a competing event to YFP repair if it is associated with inability to induce double-strand breaks or repair. Under these circumstances, treating bursting as uninformative censoring (as is done with the Kaplan Meier approach) would lead to a misleading underestimation of time-to-YFP-appearance since the burst cells have no chance of ever producing YFP. Cumulative incidence makes more sense because while it makes no assumptions that bursting is uninformative, it still accounts for reductions to the fraction of YFP appearance events due to bursting occuring prior to YFP detection. This makes cumulative incidence a useful way to assess the overall rate of cells going from YFP engative to positive over time. 


```{r}
library(purrr)
library(tidyr)
library(cmprsk)

#Only consider YFP appearance in cells where it can acutally appear
info <- filter(info,expstrain != 'SSAcontrol' & expstrain != 'SSAdegcontrol')

#renaming the strain names in expstrain so there are no spaces
info <- info %>% mutate(expstrain = if_else(expstrain =='SSA Dnl4ko','SSA_Dnl4ko',expstrain))

#Creating a status for YFP repair that distinguishes between censoring and bursting
info <- info %>% mutate(crstatus = ifelse(yfpclass=='turnedon','turnedon',lastobservation))

```


```{r}

#Get the cumulative incidence fit for the given strainname and the SSA strain
getyfpcifit_compareage <- function(strainname,events){
  events = filter(events,expstrain ==strainname)
  ci_fit<- cuminc(ftime = events$timeyfp,fstatus = events$crstatus,group = events$expage,
                 cencode = 'interference')
}


#Get the cumulative incidence fit for the given strainname and the SSA strain
getyfpcifit_comparetoSSA <- function(strainname,events){
  events = filter(events,expstrain=='SSA' | expstrain ==strainname)
  ci_fit<- cuminc(ftime = events$timeyfp,fstatus = events$crstatus,group = events$expstrain,
                 cencode = 'interference')
}


#Generate a plot of cumulative incidence of YFP over time, grouped by strainname
getyfpciplots_bystrain <- function(ci_fit){

ciplotdat <- ci_fit %>% list_modify("Tests" = NULL) %>%    map_df(`[`,c("time","est"),.id="id")  %>% separate(id,c("Strain","Event")," ")

ggplot(filter(ciplotdat,Event == "turnedon"),aes(x=time, y = est, color = Strain)) + geom_step(lwd = 1.2, aes(linetype = Event)) + ylim(c(0,1)) + xtscale_fltime + ylab("Cumulative Incidence") + annotate("text",x=0, y=1, hjust = 0, label = paste0("p-value = ", ifelse(ci_fit$Tests[2,2] < 0.001,"<.001",round(ci_fit$Tests[1,2],3)))) + guides(linetype=FALSE)
}

#Generate a plot of cumulative incidence of YFP over time, grouped by strainname
getyfpciplots_byage <- function(ci_fit){

ciplotdat <- ci_fit %>% list_modify("Tests" = NULL) %>%    map_df(`[`,c("time","est"),.id="id")  %>% separate(id,c("Age","Event")," ")

ggplot(filter(ciplotdat,Event == "turnedon"),aes(x=time, y = est, color = Age)) + geom_step(lwd = 1.2, aes(linetype = Event)) + ylim(c(0,1)) + xtscale_fltime + ylab("Cumulative Incidence") + annotate("text",x=0, y=1, hjust = 0, label = paste0("p-value = ", ifelse(ci_fit$Tests[2,2] < 0.001,"<.001",round(ci_fit$Tests[1,2],3)))) + guides(linetype=FALSE)
}


#Plotting cumulative incidence for each old vs young experiments for each strain
strainnames = c("SSA","SSAhet","SSAdeg","SSA_Dnl4ko")
yfpcifits_youngvold = lapply(strainnames,getyfpcifit_compareage,info)
test = lapply(yfpcifits_youngvold,getyfpciplots_byage)
for(i in 1:4){test[[i]] = test[[i]] + ggtitle(strainnames[i])}
grid.arrange(grobs = test, layout_matrix = rbind(c(1,2),c(3,4)),top = "Cumulative Incidence of YFP Appearance vs Time, Old vs Young Cells")


#Plotting cumulative incidence for each old strain against that of young SSA cells
yfpcifits_vsSSAold = lapply(c("SSAhet","SSAdeg","SSA_Dnl4ko"),getyfpcifit_comparetoSSA,filter(info,expage=='young'))
test = lapply(yfpcifits_vsSSAold,getyfpciplots_bystrain)
grid.arrange(grobs = test, layout_matrix = rbind(c(1,2),c(3,4)),top = "Cumulative Incidence of YFP Appearance vs Time, Young cells")


#Plotting cumulative incidence for each old strain against that of old SSA cells
yfpcifits_vsSSAold = lapply(c("SSAhet","SSAdeg","SSA3xCln2","SSA_Dnl4ko"),getyfpcifit_comparetoSSA,filter(info,expage=='old'))
test = lapply(yfpcifits_vsSSAold,getyfpciplots_bystrain)
grid.arrange(grobs = test, layout_matrix = rbind(c(1,2),c(3,4)),top = "Cumulative Incidence of YFP Appearance vs Time, Old cells")


#ggcompeting risks is easier, but it plots all cumulative incidences.  
# ggcompetingrisks(fit = ci_fitold,multiple_panels = TRUE, xlab = "30 minute increments",
#                  ylab = "Cumulative incidence of event", title = "repair and death by strain",
#                  ylim = c(0,1))

```
For all strains, the cumulative incidence of YFP appearance was lower in old cells than it was for young cells. As discussed earlier, the cumulative incidence for YFP appearance includes the influence of bursting events that prevent observation of YFP repair. There is definitely a higher rate of bursting in old cells compared to young cells, so this cannot be ruled out as a reason for the lower cumulative incidence of YFP appearance in old cells. Also, the difference in cumulative incidence curves between young and old cells  do not not necessarily mean that old cells are worse at repair.

In young cells the only strain with a statistically significant difference in its cumulative incidence curve from the SSA strain is the SSAhet strain. This agrees with what is know in the literature about heterology in SSA repair casettes decreasing the rate of repair. All other strains have a similar cumulative incidence curves over time.

In old cells, the cumulative incidence curves plateau at a lower level.  For the SSA strain this is around a level of 0.62. The SSAhet strain again has a cumulative incidence curve that shows a statistically significant difference from the SSA strain. All other curves fail to show a statistically signficant difference. The SSA3xCln2 and SSAdeg cumulative incidences do look like they reach a higher plateau than SSA though.

While the cumulative incidence curves don't provide much specific insight into what is happening with SSA repair across strains and between young and old cells, they provide an overall sense of what is happening to cells in the experiments. In the old experiments, fewer cells produce YFP over time than in young cells.  

### 4. Cause specific hazard modeling of time-to-YFP-appearance using proportional hazards regression.

The cumulative incidence estimates the marginal probability of YFP repair in time < T, while accounting for the competing risk of bursting.  Any interpretation of different cumulative incidence curves with age depends on assumptions about how bursting is related to time to YFP repair. Do bust cells have a different time-to-repair distribution than cells that don't burst? Since we don't know the answer to this question, we now focus only on cells that do not burst. We model the cause specific hazard rate for YFP repair. This is the instantaneous rate of YFP repair in a given time interval for those cells that have not burst and that are YFP negative.  Bursting events are censored.

```{r}
library(tidyr)
library(gtsummary)

#cause specific hazards on strain for old cells
cshr_fit <-
  coxph(
    Surv(timeyfp,statusyfp) ~ expstrain+expage, data=info
  )

gtsummary::tbl_regression(cshr_fit, exp = TRUE)

```
The above results are for a cox proportional hazards regression using the cause specific hazard approach (treating all bursting events as censoring).  In this case the hazard is with respect to YFP repair. The results are the hazard ratios for each strain (except for SSA) and each age (except for old cells) with respect to old SSA cells.  The significant coefficients are for the SSA3xCln2 strain with a hazard ratio of 1.49, SSAhet strain with a hazard ratio of 0.25, and the youmg coefficient with a hazard ratio of 1.67.  

Below, I check the Cox proportional hazards assumption that hazards are proportional at each point in time throughout followup. To do this I use the cox.zph function.  It performs a hypothesis test of whether the effect of each covariate differs over time and a global test of all covariates at once. It also plots the Schoenfeld residuals - 'deviation from a zero-slope line is evidence that the proportional hazards assumption is violated
```{r}
mv_fit <- coxph(Surv(timeyfp,statusyfp) ~ expstrain + expage, data=info)
cz <- cox.zph(mv_fit)
print(cz)
plot(cz)
```
There appears to be an increasing trend in the Schoenfeld residuals for strain with respect to time. There is less of a clear pattern in the Schoenfeld residuals with respect to age.  The hypothesis tests of whether the effect of age and strain on cause-specific hazard change over time also produced significant p-values (< 0.05).  The proportional hazards assumption appears to be violated. The hazard ratios for strain and age listed above are not so trustworthy. 



